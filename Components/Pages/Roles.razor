@page "/roles"
@inject RoleApiController RoleApi
@inject DialogService DialogService
@inject NotificationService NotificationService
@rendermode InteractiveServer

<PageTitle>Roles</PageTitle>

<div style="margin-bottom: 2rem;">
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <div>
            <RadzenText TextStyle="TextStyle.DisplayH4" style="margin: 0 0 0.5rem 0; font-weight: 700;">Roles</RadzenText>
            <RadzenText TextStyle="TextStyle.Body1" style="margin: 0;">Manage user roles</RadzenText>
        </div>
        <RadzenButton Text="Create Role" Icon="add" Click="CreateRole" ButtonStyle="ButtonStyle.Primary" 
                      style="padding: 0.75rem 1.5rem; border-radius: 8px;" />
    </RadzenStack>
</div>

<RadzenRow Gap="1rem" style="margin-bottom: 2rem;">
    <RadzenColumn Size="12">
        <RadzenCard>
            <RadzenText TextStyle="TextStyle.H6" style="margin-bottom: 1rem;">Role Distribution</RadzenText>
            <RadzenChart>
                <RadzenPieSeries Data="@roleData" Title="Roles" CategoryProperty="RoleName" ValueProperty="Count">
                    <RadzenSeriesDataLabels Visible="true" />
                </RadzenPieSeries>
            </RadzenChart>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

<RadzenRow>
    <RadzenColumn>
        <RadzenCard>
            @if (loading)
            {
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            }
            else if (roles != null)
            {
                <RadzenDataGrid Data="@roles" TItem="Role" AllowFiltering="true" AllowSorting="true" AllowPaging="true" PageSize="10" class="rz-datagrid">
                    <Columns>
                        <RadzenDataGridColumn TItem="Role" Property="roleId" Title="ID" />
                        <RadzenDataGridColumn TItem="Role" Property="roleName" Title="Name" />
                        <RadzenDataGridColumn TItem="Role" Property="roleDescription" Title="Description" />
                        <RadzenDataGridColumn TItem="Role" Title="Actions" Sortable="false" Filterable="false">
                            <Template Context="role">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                                    <RadzenButton Icon="edit" Size="ButtonSize.Small" Variant="Variant.Flat" Click="@(() => EditRole(role))" />
                                    <RadzenButton Icon="delete" Size="ButtonSize.Small" Variant="Variant.Flat" Click="@(() => DeleteRole(role))" />
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            }
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    private List<Role>? roles;
    private bool loading = false;
    private List<RoleData> roleData = new();

    public class RoleData
    {
        public string RoleName { get; set; } = "";
        public int Count { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
    }

    private async Task LoadRoles()
    {
        loading = true;
        try
        {
            var response = await RoleApi.GetAllRoles();
            if (response.IsSuccessful && !string.IsNullOrEmpty(response.Content))
            {
                roles = STJ.JsonSerializer.Deserialize<List<Role>>(response.Content);
                
                // Calculate role distribution (each role counts as 1)
                roleData = roles
                    .Where(r => !string.IsNullOrEmpty(r.roleName))
                    .Select(r => new RoleData { RoleName = r.roleName, Count = 1 })
                    .ToList();
            }
            else
            {
                NotificationService.Notify(new NotificationMessage 
                { 
                    Severity = NotificationSeverity.Error, 
                    Summary = "Error", 
                    Detail = $"Failed to load roles: {response.StatusDescription}" 
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage 
            { 
                Severity = NotificationSeverity.Error, 
                Summary = "Error", 
                Detail = ex.Message 
            });
        }
        finally
        {
            loading = false;
        }
    }

    private async Task CreateRole()
    {
        var role = new Role { roleId = roles.Count() > 0 ? roles.Last().roleId + 1 : 0, roleName = "", roleDescription = "" };
        var result = await DialogService.OpenAsync<RoleForm>("Create Role", new Dictionary<string, object> { { "Role", role } }, new DialogOptions { Width = "500px" });
        
        if (result == true)
        {
            await LoadRoles();
        }
    }

    private async Task EditRole(Role role)
    {
        var result = await DialogService.OpenAsync<RoleForm>("Edit Role", new Dictionary<string, object> { { "Role", role } }, new DialogOptions { Width = "500px" });
        
        if (result == true)
        {
            await LoadRoles();
        }
    }

    private async Task DeleteRole(Role role)
    {
        var result = await DialogService.Confirm($"Are you sure you want to delete role '{role.roleName}'?", "Delete Role", new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });
        
        if (result == true)
        {
            loading = true;
            try
            {
                var response = await RoleApi.DeleteRole(role.roleId);
                if (response.IsSuccessful)
                {
                    NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Success", Detail = "Role deleted successfully" });
                    await LoadRoles();
                }
                else
                {
                    NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = "Failed to delete role" });
                }
            }
            catch (Exception ex)
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = ex.Message });
            }
            finally
            {
                loading = false;
            }
        }
    }
}

