@* @page "/api-storage" *@
@inject APIStorageApiController APIStorageApi
@inject DialogService DialogService
@inject NotificationService NotificationService
@rendermode InteractiveServer

<PageTitle>API Storage</PageTitle>

<RadzenRow>
    <RadzenColumn>
        <RadzenCard>
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <div>
                    <h2>API Storage</h2>
                    <p>Manage API keys and secrets</p>
                </div>
                <RadzenButton Text="Create API Key" Icon="add" Click="CreateAPIStorage" />
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

<RadzenRow>
    <RadzenColumn>
        <RadzenCard>
            @if (loading)
            {
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            }
            else if (apiStorages != null)
            {
                <RadzenDataGrid Data="@apiStorages" TItem="APIStorage" AllowFiltering="true" AllowSorting="true" AllowPaging="true" PageSize="10" class="rz-datagrid">
                    <Columns>
                        <RadzenDataGridColumn TItem="APIStorage" Property="Id" Title="ID" />
                        <RadzenDataGridColumn TItem="APIStorage" Property="applicationName" Title="Application Name" />
                        <RadzenDataGridColumn TItem="APIStorage" Title="API Secret" Sortable="false" Filterable="false">
                            <Template Context="apiStorage">
                                <RadzenText>@MaskSecret(apiStorage.apiSecret)</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="APIStorage" Title="Actions" Sortable="false" Filterable="false">
                            <Template Context="apiStorage">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                                    <RadzenButton Icon="edit" Size="ButtonSize.Small" Variant="Variant.Flat" Click="@(() => EditAPIStorage(apiStorage))" />
                                    <RadzenButton Icon="delete" Size="ButtonSize.Small" Variant="Variant.Flat" Click="@(() => DeleteAPIStorage(apiStorage))" />
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            }
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>


@code {
    private List<APIStorage>? apiStorages;
    private bool loading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadAPIStorages();
    }

    private async Task LoadAPIStorages()
    {
        loading = true;
        try
        {
            var response = await APIStorageApi.GetAllAPIStorages();
            if (response.IsSuccessful && !string.IsNullOrEmpty(response.Content))
            {
                apiStorages = STJ.JsonSerializer.Deserialize<List<APIStorage>>(response.Content);
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = $"Failed to load API storages: {response.StatusDescription}"
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = ex.Message
            });
        }
        finally
        {
            loading = false;
        }
    }

    private string MaskSecret(string secret)
    {
        if (string.IsNullOrEmpty(secret) || secret.Length <= 8)
            return "****";
        return secret.Substring(0, 4) + "****" + secret.Substring(secret.Length - 4);
    }

    private async Task CreateAPIStorage()
    {
        var APIStorage = new APIStorage { id = 0, applicationName = "", apiSecret = "" };
        var result = await DialogService.OpenAsync<APIStorageForm>("Create API Key", new Dictionary<string, object> { { "APIStorage", APIStorage } }, new DialogOptions { Width = "500px", CloseDialogOnOverlayClick = true });

        if (result == true)
        {
            await LoadAPIStorages();
        }
    }

    private async Task EditAPIStorage(APIStorage APIStorage)
    {
        var result = await DialogService.OpenAsync<APIStorageForm>("Edit API Key", new Dictionary<string, object> { { "APIStorage", APIStorage } }, new DialogOptions { Width = "500px" });

        if (result == true)
        {
            await LoadAPIStorages();
        }
    }

    private async Task DeleteAPIStorage(APIStorage APIStorage)
    {
        var result = await DialogService.Confirm($"Are you sure you want to delete API key for '{APIStorage.applicationName}'?", "Delete API Key", new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });

        if (result == true)
        {
            loading = true;
            try
            {
                var response = await APIStorageApi.DeleteAPIStorage(APIStorage.id);
                if (response.IsSuccessful)
                {
                    NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Success", Detail = "API key deleted successfully" });
                    await LoadAPIStorages();
                }
                else
                {
                    NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = "Failed to delete API key" });
                }
            }
            catch (Exception ex)
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = ex.Message });
            }
            finally
            {
                loading = false;
            }
        }
    }
}

